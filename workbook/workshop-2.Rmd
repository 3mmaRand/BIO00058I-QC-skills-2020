---
title:  "Topic 1: Linear models: t-tests and ANOVA revisited."
author: "Emma Rand"
output:
  html_document:
    toc: true
    depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: yeti
  word_document: default
---
![](../pics/58I.png)
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      include = FALSE)
```

```{r pkgs}
library(tidyverse)
library(multcomp)
```

# Introduction

## Aims
There are two aims for this topic. First to explain how the t-test, ANOVA and regression are actually all the same test and introduce the terminology of statistical modelling and, secondly, to teach you how to use and interpret the `lm()` function in R. 

## Objectives 
By doing the independent study before each Blackboard workshop and working with others to solve workshop problems the successful student will be able to:

* Explain the link between t-tests, ANOVA and regression
* Appropriately apply linear models using `lm()`
* Interpret the results and relate them to the outputs of `t.test()` and `aov()`

Note that you should also be able to report the results of the examples and workshop problems which was a Stage 1 learning objective for 17C and 8C.

## Independent Study

This should have been carried out before the workshop.
There is a text book, gist-lm: Get Introductory Statistical Tests as Linear models: A guide for R users to support this topic which is freely available here:  [gist-lm: Get Introductory Statistical Tests as Linear models: A guide for R users](https://3mmarand.github.io/gist-lm/)

We suggested you carry out the independent study in two sessions:

1. Read the Preface, Introduction (Chapters 1-3) and Chapter 4 Single linear regression
2. Read Chapters 6 and 7

# Instructions

Designate roles: 

1. the code host  
2. the report host  

The code host types the code and comments that you collaboratively write. The report host types the report using googledocs that you collaboratively write. At the start of a problem the code host shares their screen showing RStudio and towards the end, the report host will share their screen.

For each data scenario:

* use a new RStudio Project containing folders: `data-raw`, `scripts` and `figures`
* check you understand the structure of the data
* identify the response and explanatory variables
* make a quick plot of the data and summarise it
* build a model with `lm()` and examine it using `summary()`
* what are the model coefficients and how do they relate to the group means
* what proportion of the variance in the response is explained by the model? 
* evaluate whether the assumptions of the linear model are met
* determine whether the effects are significant  
* write a report on the results. This will be no more than a few sentences reporting the results and an accompanying figure which you also write to file. 
* post your report to the padlet
* go through your code adding comments, removing code that no longer reflects steps in your analysis and reporting, and reordering where necessary  
* examine some of the other reports posted on the padlet. What did you do well? What could you have done better? Add these as comments to your own padlet post
* make sure the RStudio Project and the googledoc is shared with everyone in your group



# Data scenarios

## 1. 



This example examines the progression of Parkinson's disease in flies with a Parkinson's disease-associated mutation.
The effect of age on locomoter ability of flies with a Parkinson's disease-associated mutation was determined by using a climbing assay. Ten flies of each tested age were placed in 3 replicate vials and the number able to climb to a set height within set time was recorded.
The data in are [park.txt](../data/park.txt) and the ages are given in days. Each row is a vial. Can you predict the number of mutant flies able to climb by their age?  

```{r }
#============== WORKBOOK EXAMPLE ==============#
# Disease progression in Parkinson's disease-associated mutants
# write comments in your scripts!

# read in the data file
park <- read.table("../data/park.txt", header = T)

# check you understand the structure of the data
str(park)
# there are two variables and 21 observations. Both variables are integers

# identify the response and explanatory variables
# the response is 'flies'; the explanatory variable is 'age'

# build a model with `glm()`
mod <- glm(data = park, flies ~ age, family = "poisson")

# examine the model result using `summary()` and `anova()`
summary(mod)
anova(mod, test = "Chisq")

# what are the model estimates?
# can be read from summary or accessed like this:
mod$coefficients
# note that the lm() estimates could have been accessed this way too

# the model estimates are logged (to base e), therefore need to be antilogged for interpretation. Antilog is exp()
exp(mod$coefficients) 
#(Intercept)         age 
#  6.8935499   0.9621374

# interpret the results 
# 6.9 flies are expected to be able to climb at age 0 (the intercept). For each day they age, the number that can climb is reduced significantly by a factor of 0.96 (p = 0.00719).
# The Analysis of Deviance Table shows that overall the model is significantly better than a NULL model. A null model is one in which the response is unexplained. Another way to express this is to say the model expalins a signifcant amount of variation in the response.
# For glm() it is deviance rather than variance that tells us about model fit.

# use `plot(mod, which = 1)` and `plot(mod, which = 2)` to examine the assumptions
plot(mod, which = 1)
plot(mod, which = 2)
# These look ok, though note that it is difficult to tell with small samples. However, there is nothing that screams the assumptions are unmet.

# plot
ggplot(data = park, aes(x = age, y = flies)) +
  geom_point() + 
  geom_smooth(method = "glm",
              method.args = list(family = "poisson"),
              se = FALSE) +
  xlab("Age (days)") +
  ylab("Number of flies able to climb") +
  theme_classic()

```

----------------------------------------

### Protein kinase

This example concerns the effect of a Mitogen-activated protein (MAP) Kinase Inhibitor on the number of nuclei in neurons
The importance of Mitogen-activated protein kinases in regulating cell division led researchers to hypothesise that MAPK inhibition might effect cytokinesis following mitosis. They treated samples of neurons with PD089059, a MAPK inhibitor, at various concentrations (1 to 15 in arbitrary units) and recorded the number of nuclei per cell.
The data in are [kinase.txt](../data/kinase.txt). Each row is a cell. Can you predict the number of nuclei by PD089059 concentration?  

```{r }
#============== WORKBOOK EXAMPLE ==============#
# The effect of a MAPK Kinase Inhibitor on the number of nuclei in neurons
# write comments in your scripts!

# read in the data file
kinase <- read.table("../data/kinase.txt", header = T)

# check you understand the structure of the data
str(kinase)
# there are two variables and 30 observations. Both variables are integers

# identify the response and explanatory variables
# the response is 'nuclei'; the explanatory variable is 'pdconc'

# build a model with `glm()`
mod <- glm(data = kinase, nuclei ~ pdconc, family = "poisson")

# examine the model result using `summary()` and `anova()`
summary(mod)
anova(mod, test = "Chisq")

# what are the model estimates?
# can be read from summary or accessed like this:
mod$coefficients
# note that the lm() estimates could have been accessed this way too

# the model estimates are logged (to base e), therefore need to be antilogged for interpretation. Antilog is exp()
exp(mod$coefficients) 
# (Intercept)      pdconc 
#    1.007766    1.089617  

# interpret the results 
# 1.01 nuclei are expected when pdconc is zero (the intercept). For each unit increase in pdconce, the number that nuclei increases significantly by a factor of 1.09 (p = 0.00624).
# The Analysis of Deviance Table shows that overall the model is significantly better than a NULL model. A null model is one in which the response is unexplained. Another way to express this is to say the model explains a signifcant amount of variation in the response.
# For glm() it is deviance rather than variance that tells us about model fit.

# use `plot(mod, which = 1)` and `plot(mod, which = 2)` to examine the assumptions
plot(mod, which = 1)
plot(mod, which = 2)
# These look ok, though note that it is difficult to tell with small samples. However, there is nothing that screams the assumptions are unmet.

# plot
ggplot(data = kinase, aes(x = pdconc, y = nuclei)) +
  geom_point() + 
  geom_smooth(method = "glm",
              method.args = list(family = "poisson"),
              se = FALSE) +
  xlab("PD089059 concentration") +
  ylab("Number of nuclei") +
  theme_classic()

```

----------------------------------------


## Section 2

**Choose one of the following examples**

### Number of mutations

This example is about how the number of mutations in a hypermutable tetranucleotide marker is affected by a person's age and whether of not they have cancer.
The number of mutations in the hypermutable tetranucleotide marker D7S1482 were analysed in buccal specimens from 30 head and neck carcinoma cases and 43 controls. Also recorded was the subject's age (in years). The goal of analysis was to determine whether age and cancer status could predict the number of mutations. The data are in  [mutation.txt](../data/mutation.txt) and comprise the following variables:

* mut : the number of mutations
* age : a continuous measure of the subject's age to the nearest 0.1 of a degree.
* cat : a factor with two levels, "control" and "tumour"


```{r }
#============== WORKBOOK EXAMPLE ==============#
#The effect of age and cancer status on the number of mutations in a hypermutable tetranucleotide marker
# read in the data file
mutation <- read.table("../data/mutation.txt", header = TRUE)

# check you understand the structure of the data
str(mutation)
# there are three variables and 73 observations. Two variables are numbers, 
# one is a factor with two levels

# identify the response and explanatory variables
# the response is 'mut'; the explanatory variables are 'age' and 'cat'

# build a model with `glm()`
mod <- glm(data = mutation, mut ~ cat * age, family = "poisson")

# examine the model result using `summary()` and `anova()`
summary(mod)
anova(mod, test = "Chisq")

# what are the model estimates?
# can be read from summary or accessed like this:
mod$coefficients
# note that the lm() estimates could have been accessed this way too

# the model estimates are logged (to base e), therefore need to be antilogged for interpretation. Antilog is exp()
exp(mod$coefficients) 
# (Intercept)     cattumour           age cattumour:age 
#    7.863668      1.335158      1.008159      1.015422  

# interpret the results 
# the intercept is the number of mutations when the cat factor is control (level 1) and age is zero, 7.89 mutations. This increases but not significantly, by a factor of 1.34 in the tumour group. For every unit increase in age in the control group, the number of mutations increases by a factor of 1.01 (NS) but there is a bigger effect of age on the number of mutations in the tumour group. Based on the effects of cat and age we would expect an increasee of 7.863668*1.008159*1.335158 = 10.5849 mutations per unit of age in the tumour group. But we get 7.863668*1.008159*1.335158*1.015422 = 10.74814

# one way to help you think about the results is to make the predictions
# this requires creating a data frame of the x values fromn which you want to predict
newdata <- data.frame(cat = rep(c("control", "tumour"), each = 3), age = rep(c(0:2), times = 2))
# then predicting
newdata$pred <- predict(mod, newdata = newdata, type = "response")
# The Analysis of Deviance Table shows that the effects of age, cat and the interaction between them are significant.
# For glm() it is deviance rather than variance that tells us about model fit.

# use `plot(mod, which = 1)` and `plot(mod, which = 2)` to examine the assumptions
plot(mod, which = 1)
plot(mod, which = 2)
# These look ok.

# plot
ggplot(data = mutation, aes(x = age, y = mut, colour = cat)) +
  geom_point() + 
  geom_smooth(method = "glm",
              method.args = list(family = "poisson"),
              se = FALSE) +
  scale_color_manual(values = c("black", "gray75"), 
                       name = "Patient\nCategory",
                       labels = c("Control", "Tumour")) +
  xlab("Age (years)") +
  ylab("Number of mutations") +
  theme_classic()

```




# The Rmd file

[Rmd file](workshop-2.Rmd)



![](../pics/58Iend.png)


